--Storage integration

CREATE OR REPLACE STORAGE INTEGRATION AUTO_HUB_SI_PROD02_S3
  TYPE = EXTERNAL_STAGE
  STORAGE_PROVIDER = S3
  STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::463224243948:role/s3_snowflake_access_role_prod'
  ENABLED = TRUE
  STORAGE_ALLOWED_LOCATIONS = ('s3://duploservices-prod02-workflow-log-sink-463224243948/');
  
DESC INTEGRATION AUTO_HUB_SI_PROD02_S3;
  
--Stage Creation

CREATE OR REPLACE STAGE "ELEMENT5_DB"."ELEMENT5_DB_SCHEMA".AUTO_HUB_PROD02_STAGE
STORAGE_INTEGRATION = AUTO_HUB_SI_PROD02_S3
URL = 's3://duploservices-prod02-workflow-log-sink-463224243948/topics/'
DIRECTORY = (ENABLE = TRUE AUTO_REFRESH = TRUE)
COMMENT = 'PROD STAGE FOR LOADING DATA TO CONNECT TO AWS S3';
  
  
LIST @"ELEMENT5_DB"."ELEMENT5_DB_SCHEMA".AUTO_HUB_PROD02_STAGE;


CREATE OR REPLACE STAGE "ELEMENT5_DB"."ELEMENT5_DB_SCHEMA".AUTO_HUB_PROD02_STAGE_MIGRATION
STORAGE_INTEGRATION = AUTO_HUB_SI_PROD02_S3
URL = 's3://duploservices-prod02-workflow-log-sink-463224243948/topics/workflow-log-event-prod02/partition=0/'
DIRECTORY = (ENABLE = TRUE AUTO_REFRESH = TRUE)
COMMENT = 'PROD STAGE FOR LOADING DATA TO CONNECT TO AWS S3';
 
LIST @"ELEMENT5_DB"."ELEMENT5_DB_SCHEMA".AUTO_HUB_PROD02_STAGE_MIGRATION;

-- External Function

create or replace external function AUTO_HUB_2_0_ALERT_EXTERNAL_FUNCTION
(ALERT_DATA variant)
 returns variant
 api_integration = AUTO_HUB_2_0_ALERT_API_INTEGRATION_PROD
 as 'https://d4m70ioqn5.execute-api.us-west-2.amazonaws.com/prod';
 
 -- API Integration 
 
 CREATE OR REPLACE api integration AUTO_HUB_2_0_ALERT_API_INTEGRATION_PROD
 api_provider = aws_api_gateway
 api_aws_role_arn = 'arn:aws:iam::463224243948:role/Automation_hub_2_0_SF_integration_role-Prod'
 enabled = true
 api_allowed_prefixes = ('https://d4m70ioqn5.execute-api.us-west-2.amazonaws.com/prod'); 

DESC api integration AUTO_HUB_2_0_ALERT_API_INTEGRATION_PROD

CREATE TABLE "ELEMENT5_DB"."ELEMENT5_DB_SCHEMA".TENANT_DETAILS AS SELECT * FROM 
"DEV_DB"."DEV_DB_SCHEMA"."TENANT_DETAILS" WHERE 2 = 1;


CREATE TABLE "ELEMENT5_DB"."ELEMENT5_DB_SCHEMA".WORKFLOW_MASTER AS SELECT * FROM 
"DEV_DB"."DEV_DB_SCHEMA"."WORKFLOW_MASTER" WHERE 2 = 1;

CREATE TABLE "ELEMENT5_DB"."ELEMENT5_DB_SCHEMA".USER_DETAILS_DIM AS SELECT * FROM 
"DEV_DB"."DEV_DB_SCHEMA"."USER_DETAILS_DIM" WHERE 2 = 1;

ALTER TABLE  "ELEMENT5_DB"."ELEMENT5_DB_SCHEMA"."WORKFLOW_MASTER" ADD TASK_VERSION VARCHAR(50);


SELECT * FROM "ELEMENT5_DB"."ELEMENT5_DB_SCHEMA".TENANT_DETAILS;

 create or replace TABLE "ELEMENT5_DB"."ELEMENT5_DB_SCHEMA".AUTOHUB_AUDIT_ERROR_TABLE (
	SNO NUMBER(38,0) autoincrement,
	EXECUTION_DATE_TIME TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
	ERROR_CODE VARCHAR(256),
	ERROR_STATE VARCHAR(256),
	ERROR_MESSAGE VARCHAR(256),
	ERROR_LINE VARCHAR(256),
	STORED_PROCEDURE_NAME VARCHAR(256),
	FILE_NAME VARCHAR,
	TENANT_NAME VARCHAR,
	CUSTOM_ERR_CODE VARCHAR,
	DB_NAME VARCHAR,
	CUSTOM_ERR_MESSAGE VARCHAR
);


create or replace TABLE "ELEMENT5_DB"."ELEMENT5_DB_SCHEMA".AUTOHUB_AUDIT_CONTROL_TABLE (
	SNO NUMBER(38,0) autoincrement,
	EXECUTION_DATE DATE DEFAULT CURRENT_DATE(),
	STORED_PROCEDURE_NAME VARCHAR(256),
	STATUS VARCHAR(50),
	TABLE_NAME VARCHAR,
	COUNT_OF_RECORDS VARCHAR,
	START_TIME TIMESTAMP_NTZ(9),
	END_TIME TIMESTAMP_NTZ(9),
	TENANT_NAME VARCHAR,
	FILE_NAME VARCHAR
);

-- External Function Stream 
create or replace stream "ELEMENT5_DB"."ELEMENT5_DB_SCHEMA".AUTOHUB_AUDIT_ERROR_TABLE_STREAM on 
table "ELEMENT5_DB"."ELEMENT5_DB_SCHEMA".AUTOHUB_AUDIT_ERROR_TABLE;


create or replace TABLE "ELEMENT5_DB"."ELEMENT5_DB_SCHEMA".JUNK_STREAM_TABLE (
	ALERT_DATA VARIANT
);


CREATE TABLE "ELEMENT5_DB"."AMEDISYS"."STAGE_DETAILS" AS SELECT * FROM  "DEV_DB"."AMEDISYS_UI_2_0"."STAGE_DETAILS";

CREATE TABLE "ELEMENT5_DB"."AMEDISYS"."FUNCTIONAL_BLOCK_DETAILS" AS SELECT * FROM  "DEV_DB"."AMEDISYS_UI_2_0"."FUNCTIONAL_BLOCK_DETAILS";

CREATE TABLE "ELEMENT5_DB"."AMEDISYS"."STATUS_DETAILS" AS SELECT * FROM  "DEV_DB"."AMEDISYS_UI_2_0"."STATUS_DETAILS";


UPDATE "ELEMENT5_DB"."AMEDISYS"."STAGE_DETAILS" SET WORKFLOW_ID ='6340322794b570001cfa47c4';

UPDATE "ELEMENT5_DB"."AMEDISYS"."STATUS_DETAILS" SET WORKFLOW_ID ='6340322794b570001cfa47c4';

select * from ELEMENT5_DB.ELEMENT5_DB_SCHEMA.WORKFLOW_MASTER where workflow_id ='6340322794b570001cfa47c4';

SELECT * FROM ELEMENT5_DB.ELEMENT5_DB_SCHEMA.TENANT_DETAILS WHERE TENANT_ID;

SELECT * FROM "ELEMENT5_DB"."AMEDISYS"."STATUS_DETAILS";

INSERT INTO "ELEMENT5_DB"."AMEDISYS"."STATUS_DETAILS" VALUES('status_015','Stage Finished',current_timestamp(),
                                                             'WORKFLOW_MANAGER','STAGE_FINISHED',
                                                            '6340322794b570001cfa47c4');
                                                            
CREATE TABLE "ELEMENT5_DB"."HOMECARE_HOLDINGS"."STAGE_DETAILS" AS SELECT * FROM  "ELEMENT5_DB"."AMEDISYS"."STAGE_DETAILS";

CREATE TABLE "ELEMENT5_DB"."HOMECARE_HOLDINGS"."FUNCTIONAL_BLOCK_DETAILS" AS SELECT * FROM  "ELEMENT5_DB"."AMEDISYS"."FUNCTIONAL_BLOCK_DETAILS";

CREATE TABLE "ELEMENT5_DB"."HOMECARE_HOLDINGS"."STATUS_DETAILS" AS SELECT * FROM  "ELEMENT5_DB"."AMEDISYS"."STATUS_DETAILS";


UPDATE "ELEMENT5_DB"."HOMECARE_HOLDINGS"."STAGE_DETAILS" SET WORKFLOW_ID ='633d9f1dade9460023a84f23';

UPDATE "ELEMENT5_DB"."HOMECARE_HOLDINGS"."STATUS_DETAILS" SET WORKFLOW_ID ='633d9f1dade9460023a84f23';
                                                        
CREATE STREAM IF NOT EXISTS "ELEMENT5_DB"."HOMECARE_HOLDINGS".ANALYTICAL_LAYER_STREAM on 
table  "ELEMENT5_DB"."HOMECARE_HOLDINGS".TRANSACTIONS_FACT_DETAILS  APPEND_ONLY = TRUE ; 

CREATE STREAM IF NOT EXISTS "ELEMENT5_DB"."AMEDISYS".ANALYTICAL_LAYER_STREAM on 
table  "ELEMENT5_DB"."AMEDISYS".TRANSACTIONS_FACT_DETAILS  APPEND_ONLY = TRUE ; 
